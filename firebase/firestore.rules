rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      // Avoid calling get(...).data.role when the user doc doesn't exist yet.
      // This commonly happens on first login when the app is creating/merging the user profile.
      return isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'];
    }

    // Some older/admin tooling created a user profile document under a non-UID document id
    // but with identifying fields (uid/email/authEmail). Allow the signed-in user to access
    // only those legacy docs that match their own identity, and prevent changing those fields.
    function isLegacySelfDoc() {
      return isSignedIn() && (
        (resource.data.uid is string && resource.data.uid == request.auth.uid) ||
        (resource.data.email is string && resource.data.email == request.auth.token.email) ||
        (resource.data.authEmail is string && resource.data.authEmail == request.auth.token.email)
      );
    }

    function legacyIdentityUnchanged() {
      // Disallow updating identity fields to "claim" other documents.
      return (
        request.resource.data.uid == resource.data.uid &&
        request.resource.data.email == resource.data.email &&
        request.resource.data.authEmail == resource.data.authEmail
      );
    }

    // USERS COLLECTION
    // Root user documents: the owner can read and write their top-level user doc
    // Admin can read any user document
    match /adminusers/{adminId} {
      allow read: if true;
      allow write: if false;
    }

    match /users/{userId} {
      // Users can manage their own profile; admins/super_admins can manage any.
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdmin() || isLegacySelfDoc());

      // Create is limited to the canonical UID doc (or admins).
      allow create: if isSignedIn() && (request.auth.uid == userId || isAdmin());

      // Updates/deletes:
      // - user can always update/delete their canonical UID doc
      // - admins can update/delete any doc
      // - user can update/delete their legacy doc, but cannot change identity fields
      allow update, delete: if isSignedIn() && (
        request.auth.uid == userId ||
        isAdmin() ||
        (isLegacySelfDoc() && legacyIdentityUnchanged())
      );
    }
    
    // Allow authenticated owners to access any nested documents under their user
    // document (covers subcollections like ojtLogs, hiddenNotifications, etc.).
    // Admin can also access all user subcollections
    match /users/{userId}/{allPaths=**} {
      allow read, write: if isSignedIn() && (
        request.auth.uid == userId ||
        isAdmin()
      );
    }

    // COMPANIES COLLECTION
    // Authenticated users can read, only admins can write
    match /companies/{companyId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // WEEKLY REPORTS - users can only access their own reports, admin can access all
    match /users/{userId}/weeklyReports/{reportId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // OJT LOGS - users can only access their own logs, admin can access all
    match /users/{userId}/ojtLogs/{logId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // HIDDEN NOTIFICATIONS - users can only access their own hidden notifications
    match /users/{userId}/hiddenNotifications/{notificationId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // HELP DESK TEMPLATES
    // Templates can be read by any authenticated user, but only administrators can write
    match /helpDeskFiles/{fileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ADMIN FILES
    // Allow owners and admins to manage files
    match /admin_files/{docId} {
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );

      allow read, update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'
      );
    }

    // NOTIFICATIONS
    // Users can only read notifications intended for them (or admins).
    // Only the owner or admin can create/update/delete.
    match /notifications/{notificationId} {
      allow read: if request.auth != null && (
        // Recipient can read (supports both legacy and current schemas)
        (resource.data.userId is string && resource.data.userId == request.auth.uid) ||
        (resource.data.targetStudentId is string && resource.data.targetStudentId == request.auth.uid) ||
        // Admins can read all
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin']
      );
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin']
      );
      allow update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin']
      );
    }

    // META
    // App-wide lookup data (programs/fields/skills suggestions) used by SetupAccountScreen.
    // Safe to read by anyone; writes restricted to admins.
    match /meta/{docId} {
      allow read: if true;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'];
    }
    
    // REQUIREMENTS - users can access their own, admin can access all
    match /users/{userId}/requirements/{requirementId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == userId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // APPLICATIONS - allow owners and admins to manage application documents
    // Documents are named {userId}_{companyId} but we also support a userId field
    match /applications/{applicationId} {
      // Allow reads if the caller is the owner (doc id prefix) or the stored userId is the caller, or the caller is admin
      allow read: if request.auth != null && (
        // doc id starts with '<uid>_'
        applicationId.matches('^' + request.auth.uid + '_.+$') ||
        // or the document data contains userId matching the caller
        (resource.data.userId is string && resource.data.userId == request.auth.uid) ||
        // or caller is admin
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );

      // Allow create if user is creating their own application (userId field) or the caller is admin
      allow create: if request.auth != null && (
        (request.resource.data.userId is string && request.resource.data.userId == request.auth.uid) ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );

      // Allow update and delete only for owner or admin
      allow update, delete: if request.auth != null && (
        (resource.data.userId is string && resource.data.userId == request.auth.uid) ||
        (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin')
      );
    }

    // FIELDS COLLECTION â€” admin-only
    // The 'fields' collection contains canonical field values used by the admin dashboard.
    // Only administrators should be able to read/update/create these documents.
    match /fields/{fieldId} {
      allow read, create, update, delete: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // TEACHER SIGNATURES
    // Stored by teacher uid: teacher_signatures/{teacherUid}
    // Students need read access to their assigned adviser's signature,
    // and also to coordinator/adviser signatures used in generated PDFs.
    match /teacher_signatures/{teacherId} {
      allow read: if request.auth != null && (
        // owner can read their own signature
        request.auth.uid == teacherId ||
        // admins can read all signatures
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin'] ||
        // student can read their assigned adviser's signature
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.adviserId == teacherId ||
        // any signed-in user can read signatures for users who are admins/super_admins
        get(/databases/$(database)/documents/users/$(teacherId)).data.role in ['admin', 'super_admin']
      );

      allow write: if request.auth != null && (
        // owner can write their own signature
        request.auth.uid == teacherId ||
        // admins can write any signature (for back-office fixes)
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin']
      );
    }
    
    // ADMIN QUERY ACCESS
    // Allow admin to query all documents (useful for admin dashboard)
    // This rule ensures admin can perform collection group queries and other admin operations
    match /{document=**} {
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Default deny all write operations for non-admin paths
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

