rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Users can only upload to their own folder
    match /users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow each user to upload/download requirement files under requirements/{userId}/...
    match /requirements/{userId}/{allPaths=**} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // allow write by owner for uploads
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow avatars to be uploaded to avatars/{userId} and read by authenticated users
    match /avatars/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Company logos - authenticated users can read, only admins can upload
    match /companies/{companyId}/logo/{fileName} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Help Desk files are stored under helpDeskFiles/{uId}/... - allow any
    // authenticated user to read/download templates, but only admins may upload or modify
    // (UI already restricts uploads to admins; rules enforce it).
    match /helpDeskFiles/{uId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Generated documents (e.g., OJT Completion Checklist) are stored per-user.
    // Users can read/write their own generated PDFs.
    match /generatedDocuments/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Some older / alternative folders live under helpDesk/... (e.g. helpDesk/requirement,
    // helpDesk/tutorial). Allow authenticated reads for those folders too so users can
    // view images and download files placed there, while keeping writes admin-only.
    match /helpDesk/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Default deny all
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}

